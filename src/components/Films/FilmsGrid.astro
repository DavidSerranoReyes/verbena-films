---
/**
 * ðŸŽ¬ FILMS GRID COMPONENT
 * GalerÃ­a de pelÃ­culas con informaciÃ³n detallada
 */
import { t } from '../../utils/i18n';
import { films } from '../../data/films';
import { getWebpPath } from '../../utils/images';
import { getVimeoEmbedUrl } from '../../utils/formatting';
---

<section class="films-section">
  <div class="container">
    <!-- Header -->
    <div class="films-header">
      <h1 class="films-title">
        <span class="lang-es">{t('films.title', 'es')}</span>
        <span class="lang-en" style="display:none;">{t('films.title', 'en')}</span>
      </h1>
      <p class="films-description">
        <span class="lang-es">{t('films.description', 'es')}</span>
        <span class="lang-en" style="display:none;">{t('films.description', 'en')}</span>
      </p>
    </div>

    <!-- Films Grid -->
    <div class="films-grid">
      {
        films.map((film) => (
          <article class="film-card" data-film-id={film.id}>
            <!-- Poster -->
            <div class="film-poster-container">
              <picture>
                <source src={getWebpPath(film.poster)} type="image/webp" />
                <img
                  src={film.poster}
                  alt={film.title}
                  class="film-poster"
                  loading="lazy"
                  data-modal-trigger={film.id}
                />
              </picture>
            </div>

            <!-- Film Info -->
            <div class="film-info">
              <h2 class="film-title">{film.title}</h2>

              {film.year && (
                <p class="film-year">{film.year}</p>
              )}
            </div>
          </article>
        ))
      }
    </div>
  </div>

  <!-- Modal/Lightbox -->
  {
    films.map((film) => (
      <div class="film-modal" id={`modal-${film.id}`} data-film-id={film.id}>
        <div class="modal-overlay" data-modal-close></div>
        <div class="modal-content">
          <button class="modal-close" data-modal-close aria-label="Close">âœ•</button>
          
          <div class="modal-inner">
            <!-- Primary Image -->
            <picture>
              <source src={getWebpPath(film.images && film.images.length > 0 ? film.images[0] : film.poster)} type="image/webp" />
              <img
                src={film.images && film.images.length > 0 ? film.images[0] : film.poster}
                alt={film.title}
                class="modal-image"
                id={`img-${film.id}`}
              />
            </picture>
            
            <!-- Video (hidden by default) -->
            {film.trailer && (
              <div class="modal-video" id={`video-${film.id}`} style="display: none;">
                <iframe
                  src={`${getVimeoEmbedUrl(film.trailer)}?h=1080&color=d4a8b8&title=0&byline=0&portrait=0`}
                  width="100%"
                  height="100%"
                  frameborder="0"
                  allow="autoplay; fullscreen; picture-in-picture"
                  allowfullscreen
                  title={film.title}
                />
              </div>
            )}

            <!-- Play Button (shows on image) -->
            {film.trailer && (
              <button
                class="modal-play-btn"
                id={`play-btn-${film.id}`}
                data-film-id={film.id}
              >
                â–¶
              </button>
            )}
          </div>

          <!-- Info -->
          <div class="modal-info">
            <h2 class="modal-title">{film.title}</h2>
            
            <p class="modal-year">
              <span class="lang-es">{t(`film.${film.id}.year`, 'es')}</span>
              <span class="lang-en" style="display:none;">{t(`film.${film.id}.year`, 'en')}</span>
            </p>
            
            <p class="modal-meta">
              <span class="modal-label">
                <span class="lang-es">{t('films.type', 'es')}:</span>
                <span class="lang-en" style="display:none;">{t('films.type', 'en')}:</span>
              </span>
              <span>
                <span class="lang-es">{t(`film.${film.id}.type`, 'es')}</span>
                <span class="lang-en" style="display:none;">{t(`film.${film.id}.type`, 'en')}</span>
              </span>
            </p>

            {film.director && (
              <p class="modal-meta">
                <span class="modal-label">
                  <span class="lang-es">{t('films.director', 'es')}:</span>
                  <span class="lang-en" style="display:none;">{t('films.director', 'en')}:</span>
                </span>
                <span>{film.director}</span>
              </p>
            )}

            {film.country && (
              <p class="modal-meta">
                <span class="modal-label">
                  <span class="lang-es">{t('films.country', 'es')}:</span>
                  <span class="lang-en" style="display:none;">{t('films.country', 'en')}:</span>
                </span>
                <span>{film.country}</span>
              </p>
            )}

            <p class="modal-meta">
              <span class="modal-label">
                <span class="lang-es">{t('films.language', 'es')}:</span>
                <span class="lang-en" style="display:none;">{t('films.language', 'en')}:</span>
              </span>
              <span>
                <span class="lang-es">{t(`film.${film.id}.language`, 'es')}</span>
                <span class="lang-en" style="display:none;">{t(`film.${film.id}.language`, 'en')}</span>
              </span>
            </p>

            {film.writer && (
              <p class="modal-meta">
                <span class="modal-label">
                  <span class="lang-es">{t('films.writer', 'es')}:</span>
                  <span class="lang-en" style="display:none;">{t('films.writer', 'en')}:</span>
                </span>
                <span>{film.writer}</span>
              </p>
            )}

            {film.producers && (
              <p class="modal-meta">
                <span class="modal-label">
                  <span class="lang-es">{t('films.producers', 'es')}:</span>
                  <span class="lang-en" style="display:none;">{t('films.producers', 'en')}:</span>
                </span>
                <span>{film.producers}</span>
              </p>
            )}

            {film.executiveProducer && (
              <p class="modal-meta">
                <span class="modal-label">
                  <span class="lang-es">{t('films.executiveProducer', 'es')}:</span>
                  <span class="lang-en" style="display:none;">{t('films.executiveProducer', 'en')}:</span>
                </span>
                <span>{film.executiveProducer}</span>
              </p>
            )}

            {film.production && (
              <p class="modal-meta">
                <span class="modal-label">
                  <span class="lang-es">{t('films.production', 'es')}:</span>
                  <span class="lang-en" style="display:none;">{t('films.production', 'en')}:</span>
                </span>
                <span>{film.production}</span>
              </p>
            )}

            <!-- Additional Images (before synopsis) -->
            {film.images && film.images.length > 1 && (
              <div class="modal-additional-images">
                {film.images.map((image, idx) =>
                  idx > 0 && (
                    <picture>
                      <source srcset={getWebpPath(image)} type="image/webp" />
                      <img
                        src={image}
                        alt={`${film.title} - ${idx + 1}`}
                        class="modal-additional-image"
                      />
                    </picture>
                  )
                )}
              </div>
            )}

            <div class="modal-synopsis">
              <h3 class="modal-section-title">
                <span class="lang-es">{t('films.synopsis', 'es')}</span>
                <span class="lang-en" style="display:none;">{t('films.synopsis', 'en')}</span>
              </h3>
              <p>
                <span class="lang-es">{t(`film.${film.id}.synopsis`, 'es')}</span>
                <span class="lang-en" style="display:none;">{t(`film.${film.id}.synopsis`, 'en')}</span>
              </p>
            </div>

            {film.awards && film.awards.length > 0 && (
              <div class="modal-awards">
                <h3 class="modal-section-title">
                  <span class="lang-es">{t('films.awards', 'es')}</span>
                  <span class="lang-en" style="display:none;">{t('films.awards', 'en')}</span>
                </h3>
                <div class="modal-awards-list">
                  {film.awards.map((award) => (
                    <div class="award-item">
                      <span class="award-check">âœ“</span>
                      <span class="award-name">{award}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    ))
  }
</section>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .films-section {
    padding: var(--spacing-2xl) 0;
    background: var(--color-dark-bg);
    margin-top: var(--spacing-2xl);
    animation: fadeInUp 0.8s ease-out;
  }

  .films-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
    animation: slideInLeft 0.8s ease-out 0.2s backwards;
  }

  .films-title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: var(--font-weight-thin);
    margin-bottom: var(--spacing-lg);
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--color-text-primary);

    @media (max-width: 768px) {
      font-size: 2rem;
    }
  }

  .films-description {
    font-size: clamp(1rem, 1.5vw, 1.2rem);
    color: var(--color-text-secondary);
    max-width: 600px;
    margin: 0 auto;
    letter-spacing: 0.5px;
  }

  .films-grid {
    display: grid;
    /* Reduce the minimum card width to make posters smaller and avoid vertical scrolling */
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);

    @media (max-width: 1024px) {
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }

    @media (max-width: 768px) {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: var(--spacing-md);
    }

    @media (max-width: 480px) {
      grid-template-columns: 1fr;
    }
  }

  .film-card {
    background: rgba(26, 26, 26, 0.5);
    border: 1px solid rgba(212, 168, 184, 0.15);
    border-radius: 16px;
    overflow: hidden;
    transition: all var(--transition-default);
    display: flex;
    flex-direction: column;
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;

    /* Stagger animation for each card */
    &:nth-child(1) { animation-delay: 0.1s; }
    &:nth-child(2) { animation-delay: 0.2s; }
    &:nth-child(3) { animation-delay: 0.3s; }
    &:nth-child(4) { animation-delay: 0.4s; }
    &:nth-child(5) { animation-delay: 0.5s; }
    &:nth-child(6) { animation-delay: 0.6s; }
    &:nth-child(7) { animation-delay: 0.7s; }
    &:nth-child(8) { animation-delay: 0.8s; }

    &:hover {
      border-color: var(--color-accent);
      transform: translateY(-8px);
      box-shadow: 0 16px 40px rgba(212, 168, 184, 0.25);
      background: rgba(26, 26, 26, 0.9);

      .film-poster {
        transform: scale(1.08);
      }

      .film-overlay {
        opacity: 1;
      }
    }
  }

  .film-poster-container {
    position: relative;
    width: 100%;
    /* Slightly less tall aspect ratio so posters take less vertical space */
    padding-bottom: 125%; /* ~4:5 aspect ratio */
    overflow: hidden;
    max-height: 480px; /* avoid extremely tall cards on very wide screens */
    background: linear-gradient(
      135deg,
      rgba(212, 168, 184, 0.1) 0%,
      rgba(224, 184, 200, 0.1) 100%
    );

    @media (max-width: 768px) {
      padding-bottom: 140%; /* provide slightly taller look on small screens */
      max-height: 380px;
    }
  }

  .film-poster {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-default);
  }

  .film-card:hover .film-poster {
    transform: scale(1.05);
  }

  .film-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 15, 15, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--transition-default);
  }

  .film-card:hover .film-overlay {
    opacity: 1;
  }

  .play-button {
    width: 60px;
    height: 60px;
    border: 2px solid var(--color-accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
    font-size: 24px;
    text-decoration: none;
    transition: all var(--transition-default);

    &:hover {
      background: var(--color-accent);
      color: var(--color-dark-bg);
      transform: scale(1.1);
    }
  }

  .film-info {
    padding: var(--spacing-lg);
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .film-title {
    font-size: 1.3rem;
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--spacing-sm);
    color: var(--color-text-primary);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .film-year {
    font-size: 0.9rem;
    color: var(--color-accent);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--spacing-md);
    letter-spacing: 1px;
  }

  .film-meta {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-sm);
    line-height: 1.5;

    .label {
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
    }
  }

  .film-details {
    margin-top: var(--spacing-md);
    cursor: pointer;

    &[open] {
      .summary-button {
        color: var(--color-accent);
      }
    }
  }

  .summary-button {
    font-size: 0.85rem;
    font-weight: var(--font-weight-bold);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: color var(--transition-default);
    list-style: none;
    cursor: pointer;

    &:hover {
      color: var(--color-accent);
    }

    &::marker {
      display: none;
    }
  }

  .film-synopsis {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-top: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--color-border);
  }

  .awards-list {
    list-style: none;
    padding: 0;
    margin-top: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--color-border);

    li {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      padding: var(--spacing-xs) 0;
      padding-left: var(--spacing-md);
      position: relative;

      &::before {
        content: 'âœ“';
        position: absolute;
        left: 0;
        color: var(--color-accent);
        font-weight: var(--font-weight-bold);
      }
    }
  }

  /* Modal Styles */
  .film-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10010;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-default);

    &.active {
      opacity: 1;
      visibility: visible;
    }
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    cursor: pointer;
  }

  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 95%;
    max-width: 1000px;
    max-height: 90vh;
    background: var(--color-dark-bg);
    border: 1px solid rgba(212, 168, 184, 0.2);
    border-radius: 20px;
    transition: transform var(--transition-default);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);

    .film-modal.active & {
      transform: translate(-50%, -50%);
    }
  }

  .modal-close {
    position: absolute;
    top: calc(var(--spacing-sm));
    right: calc(var(--spacing-sm));
    width: 44px;
    height: 44px;
    background: rgba(212, 165, 116, 0.15);
    border: 1.5px solid var(--color-accent);
    color: var(--color-accent);
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-default);
    z-index: 10;
    border-radius: 12px;

    &:hover {
      background: var(--color-accent);
      color: var(--color-dark-bg);
      box-shadow: 0 8px 20px rgba(212, 165, 116, 0.3);
    }
  }

  .modal-inner {
    position: relative;
    width: 100%;
    height: 60vh;
    overflow: hidden;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;

    @media (max-width: 768px) {
      height: 45vh;
    }
  }

  .modal-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .modal-additional-images {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    padding: var(--spacing-lg) var(--spacing-lg) 0 var(--spacing-lg);
    background: var(--color-dark-bg);
  }

  .modal-additional-image {
    width: 40%;
    height: auto;
    object-fit: contain;
    display: block;
    border: 1px solid var(--color-border);
    padding: var(--spacing-sm);
    margin: 0 auto;
  }

  .modal-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .modal-play-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70px;
    height: 70px;
    background: rgba(212, 165, 116, 0.85);
    border: none;
    border-radius: 16px;
    color: var(--color-dark-bg);
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-default);
    z-index: 5;
    box-shadow: 0 8px 24px rgba(212, 165, 116, 0.4);

    &:hover {
      background: var(--color-accent);
      transform: translate(-50%, -50%) scale(1.12);
      box-shadow: 0 12px 36px rgba(212, 165, 116, 0.5);
    }
  }

  .modal-info {
    padding: var(--spacing-lg);
    text-align: center;
    border-top: 1px solid var(--color-border);

    @media (max-width: 768px) {
      padding: var(--spacing-md);
      text-align: left;
    }
  }

  .modal-title {
    font-size: 2rem;
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary) !important;
    margin-bottom: var(--spacing-sm);
    text-transform: uppercase !important;
    letter-spacing: 1px;

    @media (max-width: 768px) {
      font-size: 1.5rem;
    }
  }

  .modal-year {
    font-size: 1.1rem;
    color: var(--color-text-primary) !important;
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--spacing-md);
  }

  .modal-meta {
    font-size: 1rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-sm);
    display: flex;
    gap: var(--spacing-sm);
    flex-direction: row;

    @media (max-width: 768px) {
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }

    .modal-label {
      color: var(--color-accent);
      font-weight: var(--font-weight-bold);
      min-width: 80px;

      @media (max-width: 768px) {
        min-width: auto;
      }
    }
  }

  .modal-section-title {
    font-size: 1rem;
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .modal-synopsis {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--color-border);

    p {
      font-size: 1rem;
      line-height: 1.6;
      color: var(--color-text-secondary);
    }
  }

  .modal-awards {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--color-border);
  }

  .modal-awards-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    text-align: left;

    .award-item {
      display: flex;
      gap: 3.5rem;
      align-items: flex-start;
      font-size: 1rem;
      color: var(--color-text-secondary);

      .award-check {
        color: var(--color-accent);
        font-weight: var(--font-weight-bold);
        font-size: 1.2rem;
        flex-shrink: 0;
        min-width: 1.2rem;
        text-align: center;
      }

      .award-name {
        flex: 1;
      }
    }
  }
</style>

<script is:inline>
  // Film Modal/Lightbox
  function initFilmModal() {
    // Open modal on image/button click
    document.querySelectorAll('[data-modal-trigger]').forEach((trigger) => {
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        const filmId = trigger.getAttribute('data-modal-trigger');
        const modal = document.querySelector(`#modal-${filmId}`);
        if (modal) {
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      });
    });

    // Close modal on close button click
    document.querySelectorAll('[data-modal-close]').forEach((closeBtn) => {
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const modal = closeBtn.closest('.film-modal');
        if (modal) {
          closeModal(modal);
        }
      });
    });

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach((overlay) => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          const modal = overlay.closest('.film-modal');
          if (modal) {
            closeModal(modal);
          }
        }
      });
    });

    // Play button logic
    document.querySelectorAll('.modal-play-btn').forEach((playBtn) => {
      playBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const filmId = playBtn.getAttribute('data-film-id');
        playVideoModal(filmId);
      });
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const activeModal = document.querySelector('.film-modal.active');
        if (activeModal) {
          closeModal(activeModal);
        }
      }
    });
  }

  function closeModal(modal) {
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
    resetModalVideo(modal);
  }

  function playVideoModal(filmId) {
    const imageDiv = document.querySelector(`#img-${filmId}`);
    const videoDiv = document.querySelector(`#video-${filmId}`);
    const playBtn = document.querySelector(`#play-btn-${filmId}`);

    if (imageDiv && videoDiv && playBtn) {
      imageDiv.style.display = 'none';
      videoDiv.style.display = 'block';
      playBtn.style.display = 'none';

      // Play video
      const iframe = videoDiv.querySelector('iframe');
      if (iframe) {
        iframe.src = iframe.src + '&autoplay=1';
      }
    }
  }

  function resetModalVideo(modal) {
    const filmId = modal.getAttribute('data-film-id');
    const imageDiv = document.querySelector(`#img-${filmId}`);
    const videoDiv = document.querySelector(`#video-${filmId}`);
    const playBtn = document.querySelector(`#play-btn-${filmId}`);

    if (imageDiv && videoDiv && playBtn) {
      imageDiv.style.display = 'block';
      videoDiv.style.display = 'none';
      playBtn.style.display = 'flex';

      // Reset iframe
      const iframe = videoDiv.querySelector('iframe');
      if (iframe) {
        const src = iframe.src.replace('&autoplay=1', '');
        iframe.src = src;
      }
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFilmModal);
  } else {
    initFilmModal();
  }
</script>
