---
/**
 * ðŸŽ¬ NAVIGATION COMPONENT
 * Barra de navegaciÃ³n con selector de idiomas
 */
import { t, type Language } from '../../utils/i18n';

const SITE_CONFIG = {
  navigation: [
    { id: 'home', label: 'home', href: '/' },
    { id: 'films', label: 'films', href: '/films' },
    { id: 'about', label: 'about', href: '/about' },
    { id: 'news', label: 'news', href: '/news' },
  ],
};

interface Props {
  currentLang?: Language;
}

const { currentLang = 'es' } = Astro.props;
---

<nav class="navbar">
  <div class="navbar-container">
    <!-- Logo -->
    <div class="navbar-logo">
      <a href="/">
        <picture>
          <source srcset="/images/logo/verbenafilms.webp" type="image/webp" />
          <img src="/images/logo/verbenafilms.png" alt="Verbena Films" class="logo-image" />
        </picture>
      </a>
    </div>

    <!-- Navigation Links -->
    <ul class="navbar-links" id="navbarLinks">
      {
        SITE_CONFIG.navigation.map((item) => (
          <li>
            <a href={item.href} class="nav-link">
              <span class="lang-es">{t(`nav.${item.label}`, 'es')}</span>
              <span class="lang-en" style="display:none;">{t(`nav.${item.label}`, 'en')}</span>
            </a>
          </li>
        ))
      }
    </ul>

    <!-- Right Controls Group: Language Switcher + Menu -->
    <div class="navbar-right-controls">
      <!-- Language Switcher -->
      <div class="language-switcher">
        <button
          class={`lang-btn ${currentLang === 'es' ? 'active' : ''}`}
          data-lang="es"
          aria-label="Cambiar a EspaÃ±ol"
        >
          ES
        </button>
        <span class="lang-divider">/</span>
        <button
          class={`lang-btn ${currentLang === 'en' ? 'active' : ''}`}
          data-lang="en"
          aria-label="Switch to English"
        >
          EN
        </button>
      </div>

      <!-- Menu Toggle (Mobile) -->
      <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <!-- Mobile Close Button (positioned fixed, appears when menu is open) -->
      <button class="mobile-close-btn" id="mobileCloseBtn" aria-label="Cerrar menÃº" style="display: none;">
        âœ•
      </button>

      <!-- Desktop Menu Button -->
      <button class="desktop-menu-btn" id="desktopMenuBtn" aria-label="Open menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</nav>

<!-- Mobile Menu Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<style>
  .navbar {
    position: fixed;
    top: 0;
    width: 100%;
    height: var(--spacing-2xl);
    background: rgba(15, 15, 15, 0.3);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(212, 168, 184, 0.2);
    z-index: 1000;
  }

  .navbar-container {
    width: 100%;
    padding: 0 var(--spacing-lg);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    gap: var(--spacing-md);

    @media (max-width: 768px) {
      padding: 0 var(--spacing-sm);
      gap: var(--spacing-sm);
    }
  }

  .navbar-logo {
    flex-shrink: 0;
    margin-left: 0;

    @media (max-width: 768px) {
      margin-left: 0;
    }
  }

  .navbar-right-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-left: auto;
    margin-right: var(--spacing-sm);
    flex-shrink: 0;

    @media (max-width: 768px) {
      margin-right: 0;
      gap: var(--spacing-sm);
    }
  }

  .navbar-logo a {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    text-decoration: none;
    transition: opacity var(--transition-default);

    &:hover {
      opacity: 0.8;
    }
  }

  .logo-image {
    height: 40px;
    width: auto;
    object-fit: contain;
    filter: invert(1) brightness(1.1);
    
    @media (max-width: 768px) {
      height: 32px;
    }
  }

  .logo-text {
    color: var(--color-text-primary);

    &.accent {
      color: var(--color-accent);
    }
  }

  .menu-toggle {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    position: relative;
    width: 32px;
    height: 32px;
    color: var(--color-text-primary);
    transition: color var(--transition-default);
    font-size: 28px;

    @media (max-width: 768px) {
      display: flex;
      align-items: center;
      justify-content: center;
      order: 2;
    }

    &:hover {
      color: var(--color-accent);
    }

    &.active {
      color: var(--color-accent);
    }

    :global(svg) {
      width: 1em;
      height: 1em;
    }
  }

  .navbar-links {
    display: none;
    list-style: none;
    gap: var(--spacing-xl);
    margin: 0;
    padding: 0;
    flex: 1;
    justify-content: center;

    @media (min-width: 769px) {
      &.active {
        display: flex;
      }
    }

    @media (max-width: 768px) {
      display: flex;
      position: fixed;
      top: 0;
      right: -100%;
      width: 70%;
      max-width: 400px;
      height: 100vh;
      flex-direction: column;
      gap: 0;
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-left: 2px solid rgba(212, 168, 184, 0.3);
      padding-top: var(--spacing-2xl);
      padding-bottom: var(--spacing-lg);
      padding-left: 0;
      padding-right: 0;
      overflow-y: auto;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 9999;
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.6);
      justify-content: flex-start;
      flex: initial;

      &.active {
        right: 0;
      }
    }

    li {
      @media (max-width: 768px) {
        opacity: 1 !important;
        transition: background-color 0.2s ease;
        margin-bottom: var(--spacing-md);
        
        &:hover {
          background-color: rgba(212, 168, 184, 0.05);
        }
        
        &:active {
          background-color: rgba(212, 168, 184, 0.1);
        }
      }
    }

    @keyframes slideInMenuItem {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  }

  .nav-link {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: var(--font-weight-regular);
    transition: color var(--transition-default);
    display: block;
    padding: var(--spacing-sm) 0;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 1px;
    position: relative;
    cursor: pointer;

    @media (max-width: 768px) {
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: 1.25rem;
      color: #ffffff !important;
      font-weight: 400;
      position: relative;
      z-index: 10000;
      transition: all 0.2s ease;
      letter-spacing: 1px;
      
      span {
        color: #ffffff !important;
        pointer-events: none;
      }
      
      &:hover {
        color: var(--color-accent) !important;
        
        span {
          color: var(--color-accent) !important;
        }
      }
      
      &:active {
        transform: translateX(4px);
      }
    }

    &::before {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--color-accent), transparent);
      transition: width var(--transition-default);

      @media (max-width: 768px) {
        display: none;
      }
    }

    &:hover {
      color: var(--color-accent);

      &::before {
        width: 100%;
      }
    }
  }

  .mobile-close-btn {
    background: none;
    border: none;
    color: var(--color-text-primary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color var(--transition-default);
    flex-shrink: 0;
    position: fixed;
    top: var(--spacing-md);
    right: var(--spacing-sm);
    z-index: 10001;

    @media (min-width: 769px) {
      display: none !important;
    }

    &:hover {
      color: var(--color-accent);
    }
  }

  .language-switcher {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;

    @media (max-width: 768px) {
      position: static;
      margin: 0;
      order: 1;
    }
  }

  .lang-btn {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    font-size: 0.85rem;
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    transition: all var(--transition-default);
    padding: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;

    &::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--color-accent);
      transition: width var(--transition-default);
    }

    &:hover {
      color: var(--color-accent);

      &::after {
        width: 100%;
      }
    }

    &.active {
      color: var(--color-accent);

      &::after {
        width: 100%;
      }
    }
  }

  .lang-divider {
    color: var(--color-text-secondary);
  }

  /* Desktop Menu Button */
  .desktop-menu-btn {
    display: none;
    background: none;
    border: none;
    color: var(--color-text-primary);
    cursor: pointer;
    transition: color var(--transition-default);
    padding: 0;
    align-items: center;
    justify-content: center;
    position: relative;
    width: 32px;
    height: 32px;
    font-size: 28px;
    flex-shrink: 0;

    @media (min-width: 769px) {
      display: flex;
    }

    &:hover {
      color: var(--color-accent);

      :global(svg) {
        animation: menuPulse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
    }

    &.active {
      color: var(--color-accent);
    }

    :global(svg) {
      width: 1em;
      height: 1em;
    }
  }

  @keyframes menuPulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.15);
    }
    100% {
      transform: scale(1);
    }
  }

  /* Dropdown Menu - NOT IN USE */
  .dropdown-overlay {
    display: none;
  }

  /* Mobile Menu Overlay */
  .mobile-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 30%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s ease, visibility 0.4s ease;
    z-index: 9998;
    backdrop-filter: blur(4px);

    &.active {
      opacity: 1;
      visibility: visible;
    }
  }
</style>

<script>
  // Esperar a que el DOM estÃ© completamente cargado
  document.addEventListener('DOMContentLoaded', () => {
    // Desktop Menu Toggle
    const desktopMenuBtn = document.getElementById('desktopMenuBtn');
    const navbarLinks = document.getElementById('navbarLinks');

    if (desktopMenuBtn && navbarLinks) {
      desktopMenuBtn.addEventListener('click', () => {
        navbarLinks.classList.toggle('active');
      });

      // Close menu when clicking a link
      const links = navbarLinks.querySelectorAll('a');
      links.forEach((link) => {
        link.addEventListener('click', () => {
          navbarLinks.classList.remove('active');
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!desktopMenuBtn.contains(e.target as Node) && !navbarLinks.contains(e.target as Node)) {
          navbarLinks.classList.remove('active');
        }
      });
    }

    // Mobile menu toggle (hamburger)
    const menuToggle = document.getElementById('menuToggle');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const mobileCloseBtn = document.getElementById('mobileCloseBtn');

    if (menuToggle && navbarLinks && mobileOverlay) {
      console.log('Mobile menu elements found'); // Debug
      
      // Toggle menu
      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('Menu toggle clicked'); // Debug
        
        menuToggle.classList.toggle('active');
        navbarLinks.classList.toggle('active');
        mobileOverlay.classList.toggle('active');
        
        // Show/hide close button
        if (mobileCloseBtn) {
          mobileCloseBtn.style.display = menuToggle.classList.contains('active') ? 'flex' : 'none';
        }
        
        // Prevent body scroll when menu is open
        document.body.style.overflow = menuToggle.classList.contains('active') ? 'hidden' : '';
      });

      // Close menu when clicking overlay
      mobileOverlay.addEventListener('click', () => {
        console.log('Overlay clicked'); // Debug
        menuToggle.classList.remove('active');
        navbarLinks.classList.remove('active');
        mobileOverlay.classList.remove('active');
        if (mobileCloseBtn) {
          mobileCloseBtn.style.display = 'none';
        }
        document.body.style.overflow = '';
      });

      // Close menu when clicking a link - Mobile specific handling
      const mobileLinks = navbarLinks.querySelectorAll('a');
      console.log('Found mobile links:', mobileLinks.length); // Debug
      
      mobileLinks.forEach((link, index) => {
        // Usar tanto click como touchend para mÃ³vil
        const handleLinkClick = (e: Event) => {
          e.preventDefault();
          e.stopPropagation();
          const href = link.getAttribute('href');
          console.log(`Link ${index} clicked/touched, href:`, href); // Debug
          
          // Close the menu
          menuToggle.classList.remove('active');
          navbarLinks.classList.remove('active');
          mobileOverlay.classList.remove('active');
          if (mobileCloseBtn) {
            mobileCloseBtn.style.display = 'none';
          }
          document.body.style.overflow = '';
          
          // Force navigation after a tiny delay
          setTimeout(() => {
            if (href) {
              console.log('Navigating to:', href); // Debug
              window.location.href = href;
            }
          }, 50);
        };
        
        link.addEventListener('click', handleLinkClick);
        link.addEventListener('touchend', handleLinkClick);
      });

      // Mobile close button
      if (mobileCloseBtn) {
        mobileCloseBtn.addEventListener('click', () => {
          menuToggle.classList.remove('active');
          navbarLinks.classList.remove('active');
          mobileOverlay.classList.remove('active');
          mobileCloseBtn.style.display = 'none';
          document.body.style.overflow = '';
        });
      }
    } else {
      console.error('Mobile menu elements not found:', { menuToggle, navbarLinks, mobileOverlay }); // Debug
    }

    // Language switcher
    const langButtons = document.querySelectorAll('.lang-btn');
    langButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const lang = btn.getAttribute('data-lang');
        
        if (lang === 'es' || lang === 'en') {
          // Guardar en localStorage
          localStorage.setItem('verbena-lang', lang);
          
          // Actualizar atributo lang del HTML
          document.documentElement.setAttribute('lang', lang);
          
          // Aplicar cambios inmediatamente usando la funciÃ³n global
          if (typeof (window as any).applyGlobalLanguage === 'function') {
            (window as any).applyGlobalLanguage();
          }
        }
      });
    });
  });
</script>
